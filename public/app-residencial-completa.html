<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conjunto Aralia de Castilla - Sistema Completo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'residente': '#3B82F6',      // Azul para residentes
                        'admin': '#10B981',          // Verde para administradores
                        'vigilante': '#F97316'       // Naranja para vigilantes
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'bounce-in': 'bounceIn 0.6s ease-out'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">

<!-- Pantalla de Login -->
<div id="login-screen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-600 via-blue-700 to-indigo-800">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4">
        <div class="text-center mb-8">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-home text-2xl text-white"></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Conjunto Aralia de Castilla</h1>
            <p class="text-gray-600">Sistema de Gestión Residencial</p>
        </div>

        <form id="login-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                <div class="relative">
                    <input type="email" id="login-email" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pl-11"
                           placeholder="tu-email@ejemplo.com" value="car-cbs@hotmail.com">
                    <i class="fas fa-envelope absolute left-3 top-3.5 text-gray-400"></i>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Contraseña</label>
                <div class="relative">
                    <input type="password" id="login-password" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pl-11"
                           placeholder="Tu contraseña" value="password1">
                    <i class="fas fa-lock absolute left-3 top-3.5 text-gray-400"></i>
                </div>
            </div>

            <button type="submit"
                    class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 px-4 rounded-lg font-medium hover:from-blue-700 hover:to-indigo-700 transition-all duration-200 shadow-lg">
                <i class="fas fa-sign-in-alt mr-2"></i>Iniciar Sesión
            </button>
        </form>

        <!-- Usuarios Demo -->
        <div class="mt-6 text-xs text-gray-500 text-center">
            <p class="mb-2">Usuarios Demo:</p>
            <div class="space-y-1">
                <p><span class="text-residente">●</span> Residente: car-cbs@hotmail.com / password1</p>
                <p><span class="text-admin">●</span> Administrador: shayoja@hotmail.com / password2</p>
                <p><span class="text-vigilante">●</span> Vigilante: car02cbs@gmail.com / password3</p>
            </div>
        </div>
    </div>
</div>

<!-- App Principal -->
<div id="app" class="min-h-screen hidden">
    <!-- Header -->
    <header id="app-header" class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <div id="role-indicator" class="w-4 h-4 rounded-full mr-3"></div>
                    <h1 class="text-xl font-semibold text-gray-900">Conjunto Aralia de Castilla</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="user-info" class="text-sm text-gray-600"></span>
                    <button onclick="logout()" class="text-gray-500 hover:text-red-600 transition-colors">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navegación por Tabs -->
    <nav id="tab-navigation" class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div id="tab-container" class="flex space-x-8 overflow-x-auto">
                <!-- Las tabs se generarán dinámicamente según el rol -->
            </div>
        </div>
    </nav>

    <!-- Contenido Principal -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div id="content-area">
            <!-- El contenido se carga dinámicamente -->
        </div>
    </main>
</div>

<!-- Modal de Notificaciones -->
<div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Notificación</h3>
                    <button onclick="closeNotificationModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="notification-content"></div>
                <div class="mt-6 flex justify-end">
                    <button onclick="closeNotificationModal()"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Entendido
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Variables globales
let currentUser = null;
let currentTab = null;

// Configuración de colores por rol
const roleColors = {
    residente: 'bg-residente',
    admin: 'bg-admin',
    vigilante: 'bg-vigilante'
};

// Configuración de tabs por rol
const tabConfigs = {
    residente: [
        { id: 'dashboard', name: 'Dashboard', icon: 'fas fa-tachometer-alt' },
        { id: 'mis-reservas', name: 'Mis Reservas', icon: 'fas fa-calendar-check' },
        { id: 'mis-pagos', name: 'Mis Pagos', icon: 'fas fa-credit-card' },
        { id: 'emprendimientos', name: 'Emprendimientos', icon: 'fas fa-store' },
        { id: 'arriendos', name: 'Ver Arriendos', icon: 'fas fa-home' },
        { id: 'sorteo-parqueadero', name: 'Mi Parqueadero', icon: 'fas fa-parking' },
        { id: 'vehiculos', name: 'Control Vehículos', icon: 'fas fa-car' },
        { id: 'paquetes', name: 'Paquetes', icon: 'fas fa-box' },
        { id: 'chat', name: 'Chat', icon: 'fas fa-comments' },
        { id: 'camaras', name: 'Cámaras', icon: 'fas fa-video' },
        { id: 'pqrs', name: 'PQRS', icon: 'fas fa-exclamation-triangle' }
    ],
    admin: [
        { id: 'dashboard-admin', name: 'Panel Admin', icon: 'fas fa-tachometer-alt' },
        { id: 'sorteo-parqueaderos', name: 'Sorteo Parqueaderos', icon: 'fas fa-random' },
        { id: 'control-vehiculos', name: 'Control Vehículos', icon: 'fas fa-car' },
        { id: 'noticias', name: 'Noticias', icon: 'fas fa-newspaper' },
        { id: 'pagos-admin', name: 'Pagos', icon: 'fas fa-money-bill' },
        { id: 'reservas-admin', name: 'Reservas', icon: 'fas fa-calendar' },
        { id: 'usuarios', name: 'Usuarios', icon: 'fas fa-users' },
        { id: 'permisos', name: 'Permisos', icon: 'fas fa-key' },
        { id: 'camaras-admin', name: 'Cámaras', icon: 'fas fa-video' },
        { id: 'pqrs-admin', name: 'PQRS', icon: 'fas fa-clipboard-list' },
        { id: 'encuestas', name: 'Encuestas', icon: 'fas fa-poll' }
    ],
    vigilante: [
        { id: 'panel-seguridad', name: 'Panel Seguridad', icon: 'fas fa-shield-alt' },
        { id: 'control-vehiculos-vigilante', name: 'Control Vehículos', icon: 'fas fa-car' },
        { id: 'permisos-vigilante', name: 'Gestión Permisos', icon: 'fas fa-key' },
        { id: 'registros', name: 'Registros', icon: 'fas fa-clipboard-list' },
        { id: 'camaras-vigilante', name: 'Cámaras', icon: 'fas fa-video' },
        { id: 'alertas', name: 'Alertas', icon: 'fas fa-exclamation-triangle' }
    ]
};

// Función de login
document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;

    try {
        const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (data.success) {
            currentUser = data.usuario;
            localStorage.setItem('token', data.token);
            localStorage.setItem('user', JSON.stringify(data.usuario));

            showApp();
        } else {
            showNotification('Error', data.mensaje || 'Credenciales inválidas', 'error');
        }
    } catch (error) {
        showNotification('Error', 'Error de conexión', 'error');
    }
});

// Mostrar la aplicación
function showApp() {
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');

    setupUserInterface();
    loadInitialTab();
}

// Configurar interfaz según usuario
function setupUserInterface() {
    const roleIndicator = document.getElementById('role-indicator');
    const userInfo = document.getElementById('user-info');
    const header = document.getElementById('app-header');

    // Configurar indicador de rol
    switch(currentUser.rol) {
        case 'residente':
            roleIndicator.className = 'w-4 h-4 rounded-full mr-3 bg-residente';
            header.className = 'bg-blue-50 shadow-sm border-b border-blue-200';
            break;
        case 'admin':
            roleIndicator.className = 'w-4 h-4 rounded-full mr-3 bg-admin';
            header.className = 'bg-green-50 shadow-sm border-b border-green-200';
            break;
        case 'vigilante':
            roleIndicator.className = 'w-4 h-4 rounded-full mr-3 bg-vigilante';
            header.className = 'bg-orange-50 shadow-sm border-b border-orange-200';
            break;
    }

    // Mostrar información del usuario
    userInfo.textContent = `${currentUser.nombre} - ${currentUser.apartamento}`;

    // Generar tabs
    generateTabs();
}

// Generar tabs según el rol
function generateTabs() {
    const tabContainer = document.getElementById('tab-container');
    const tabs = tabConfigs[currentUser.rol] || [];

    tabContainer.innerHTML = '';

    tabs.forEach(tab => {
        const tabElement = document.createElement('button');
        tabElement.className = 'py-4 px-1 border-b-2 font-medium text-sm transition-colors border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap';
        tabElement.id = `tab-${tab.id}`;
        tabElement.innerHTML = `<i class="${tab.icon} mr-2"></i>${tab.name}`;
        tabElement.onclick = () => switchTab(tab.id);

        tabContainer.appendChild(tabElement);
    });
}

// Cambiar tab
function switchTab(tabId) {
    // Remover clase activa de todos los tabs
    document.querySelectorAll('[id^="tab-"]').forEach(tab => {
        tab.className = 'py-4 px-1 border-b-2 font-medium text-sm transition-colors border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap';
    });

    // Agregar clase activa al tab seleccionado
    const selectedTab = document.getElementById(`tab-${tabId}`);
    if (selectedTab) {
        const colorClass = currentUser.rol === 'residente' ? 'border-residente text-residente' :
                          currentUser.rol === 'admin' ? 'border-admin text-admin' :
                          'border-vigilante text-vigilante';
        selectedTab.className = `py-4 px-1 border-b-2 font-medium text-sm transition-colors ${colorClass} whitespace-nowrap`;
    }

    currentTab = tabId;
    loadTabContent(tabId);
}

// Cargar primer tab
function loadInitialTab() {
    const firstTab = tabConfigs[currentUser.rol][0];
    if (firstTab) {
        switchTab(firstTab.id);
    }
}

// Cargar contenido del tab
function loadTabContent(tabId) {
    const contentArea = document.getElementById('content-area');

    switch(tabId) {
        case 'dashboard':
            loadResidenteDashboard();
            break;
        case 'mis-reservas':
            loadMisReservas();
            break;
        case 'mis-pagos':
            loadMisPagos();
            break;
        case 'emprendimientos':
            loadEmprendimientos();
            break;
        case 'arriendos':
            loadArriendos();
            break;
        case 'sorteo-parqueadero':
            loadMiParqueadero();
            break;
        case 'vehiculos':
            loadMisVehiculos();
            break;
        case 'paquetes':
            loadPaquetes();
            break;
        case 'chat':
            loadChat();
            break;
        case 'camaras':
            loadCamaras();
            break;
        case 'pqrs':
            loadPQRS();
            break;
        case 'dashboard-admin':
            loadAdminDashboard();
            break;
        case 'noticias':
            loadNoticias();
            break;
        case 'usuarios':
            loadUsuarios();
            break;
        case 'panel-seguridad':
            loadPanelSeguridad();
            break;
        case 'control-vehiculos-vigilante':
            loadControlVehiculosVigilante();
            break;
        default:
            contentArea.innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-cog text-4xl text-gray-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Módulo en Desarrollo</h3>
                    <p class="text-gray-600">Este módulo está siendo desarrollado.</p>
                </div>
            `;
    }
}

// ================================
// MÓDULOS DE RESIDENTE
// ================================

async function loadResidenteDashboard() {
    const contentArea = document.getElementById('content-area');
    contentArea.innerHTML = `
        <div class="space-y-6">
            <!-- Header del Dashboard -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-lg p-6 text-white">
                <h2 class="text-2xl font-bold mb-2">¡Bienvenido, ${currentUser.nombre}!</h2>
                <p class="opacity-90">${currentUser.apartamento}</p>
            </div>

            <!-- Loading State -->
            <div id="dashboard-loading" class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i>
                <p class="mt-2 text-gray-600">Cargando información...</p>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboard-content" class="hidden">
                <!-- Últimas Noticias -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">
                        <i class="fas fa-newspaper text-blue-600 mr-2"></i>Últimas Noticias
                    </h3>
                    <div id="noticias-recientes"></div>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-2 bg-blue-100 rounded-lg">
                                <i class="fas fa-calendar-check text-blue-600"></i>
                            </div>
                            <div class="ml-4">
                                <h4 class="text-sm font-medium text-gray-600">Reservas Activas</h4>
                                <p id="reservas-count" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-2 bg-green-100 rounded-lg">
                                <i class="fas fa-credit-card text-green-600"></i>
                            </div>
                            <div class="ml-4">
                                <h4 class="text-sm font-medium text-gray-600">Pagos al Día</h4>
                                <p id="pagos-count" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-2 bg-purple-100 rounded-lg">
                                <i class="fas fa-car text-purple-600"></i>
                            </div>
                            <div class="ml-4">
                                <h4 class="text-sm font-medium text-gray-600">Vehículos Visitantes</h4>
                                <p id="vehiculos-count" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Últimas Actividades -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">
                            <i class="fas fa-clock text-blue-600 mr-2"></i>Últimas Reservas
                        </h3>
                        <div id="ultimas-reservas"></div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">
                            <i class="fas fa-receipt text-green-600 mr-2"></i>Últimos Recibos
                        </h3>
                        <div id="ultimos-recibos"></div>
                    </div>
                </div>
            </div>
        </div>
    `;

    try {
        const response = await fetchWithAuth('/api/residente/dashboard');
        const data = await response.json();

        if (data.success) {
            document.getElementById('dashboard-loading').classList.add('hidden');
            document.getElementById('dashboard-content').classList.remove('hidden');

            // Mostrar noticias
            const noticiasContainer = document.getElementById('noticias-recientes');
            if (data.dashboard.noticiasRecientes.length > 0) {
                noticiasContainer.innerHTML = data.dashboard.noticiasRecientes.map(noticia => `
                    <div class="border-l-4 border-blue-500 pl-4 py-2 mb-3">
                        <h4 class="font-medium text-gray-900">${noticia.titulo}</h4>
                        <p class="text-sm text-gray-600 mt-1">${noticia.contenido.substring(0, 100)}...</p>
                        <p class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-calendar mr-1"></i>${noticia.fecha}
                        </p>
                    </div>
                `).join('');
            } else {
                noticiasContainer.innerHTML = '<p class="text-gray-500 text-sm">No hay noticias recientes</p>';
            }

            // Actualizar contadores
            document.getElementById('reservas-count').textContent = data.dashboard.ultimasReservas.length;
            document.getElementById('pagos-count').textContent = data.dashboard.ultimosRecibos.length;

            // Mostrar últimas reservas
            const reservasContainer = document.getElementById('ultimas-reservas');
            if (data.dashboard.ultimasReservas.length > 0) {
                reservasContainer.innerHTML = data.dashboard.ultimasReservas.map(reserva => `
                    <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0">
                        <div>
                            <p class="font-medium text-gray-900">${reserva.espacio}</p>
                            <p class="text-sm text-gray-600">${reserva.fecha} - ${reserva.hora}</p>
                        </div>
                        <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Activa</span>
                    </div>
                `).join('');
            } else {
                reservasContainer.innerHTML = '<p class="text-gray-500 text-sm">No tienes reservas recientes</p>';
            }

            // Mostrar últimos recibos
            const recibosContainer = document.getElementById('ultimos-recibos');
            if (data.dashboard.ultimosRecibos.length > 0) {
                recibosContainer.innerHTML = data.dashboard.ultimosRecibos.map(recibo => `
                    <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0">
                        <div>
                            <p class="font-medium text-gray-900">${recibo.concepto}</p>
                            <p class="text-sm text-gray-600">$${recibo.valor.toLocaleString()}</p>
                        </div>
                        <p class="text-xs text-gray-500">${recibo.fechaPago}</p>
                    </div>
                `).join('');
            } else {
                recibosContainer.innerHTML = '<p class="text-gray-500 text-sm">No hay recibos recientes</p>';
            }
        }
    } catch (error) {
        document.getElementById('dashboard-loading').innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-exclamation-triangle text-2xl text-red-400"></i>
                <p class="mt-2 text-red-600">Error al cargar el dashboard</p>
            </div>
        `;
    }
}

async function loadMisReservas() {
    const contentArea = document.getElementById('content-area');
    contentArea.innerHTML = `
        <div class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-900">Mis Reservas</h2>
                <button onclick="showNuevaReserva()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Nueva Reserva
                </button>
            </div>

            <!-- Loading -->
            <div id="reservas-loading" class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i>
                <p class="mt-2 text-gray-600">Cargando reservas...</p>
            </div>

            <!-- Content -->
            <div id="reservas-content" class="hidden">
                <!-- Espacios Disponibles -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">Espacios Disponibles</h3>
                    <div id="espacios-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>

                <!-- Mis Reservas -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">Mis Reservas Activas</h3>
                    <div id="mis-reservas-list"></div>
                </div>
            </div>
        </div>
    `;

    try {
        const response = await fetchWithAuth('/api/residente/mis-reservas');
        const data = await response.json();

        if (data.success) {
            document.getElementById('reservas-loading').classList.add('hidden');
            document.getElementById('reservas-content').classList.remove('hidden');

            // Mostrar espacios disponibles
            const espaciosGrid = document.getElementById('espacios-grid');
            espaciosGrid.innerHTML = data.espaciosDisponibles.map(espacio => `
                <div class="border rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer" onclick="selectEspacio('${espacio.nombre}')">
                    <div class="aspect-w-16 aspect-h-9 mb-3">
                        <div class="bg-gray-200 rounded-lg flex items-center justify-center h-24">
                            <i class="fas fa-image text-gray-400 text-2xl"></i>
                        </div>
                    </div>
                    <h4 class="font-medium text-gray-900">${espacio.nombre}</h4>
                    <p class="text-sm text-gray-600 mt-1">${espacio.descripcion}</p>
                </div>
            `).join('');

            // Mostrar reservas del usuario
            const reservasList = document.getElementById('mis-reservas-list');
            if (data.misReservas.length > 0) {
                reservasList.innerHTML = data.misReservas.map(reserva => `
                    <div class="flex justify-between items-center py-3 border-b border-gray-100 last:border-b-0">
                        <div class="flex-1">
                            <div class="flex items-center">
                                <i class="fas fa-calendar-check text-blue-600 mr-2"></i>
                                <span class="font-medium text-gray-900">${reserva.espacio}</span>
                            </div>
                            <div class="mt-1 text-sm text-gray-600">
                                <i class="fas fa-clock mr-1"></i>${reserva.fecha} a las ${reserva.hora}
                                ${reserva.estado ? `<span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-1 rounded">${reserva.estado}</span>` : ''}
                            </div>
                        </div>
                        <button onclick="cancelarReserva(${reserva.id})"
                                class="text-red-600 hover:text-red-800 text-sm">
                            Cancelar
                        </button>
                    </div>
                `).join('');
            } else {
                reservasList.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-calendar text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-600">No tienes reservas activas</p>
                        <p class="text-sm text-gray-500 mt-2">Haz clic en "Nueva Reserva" para crear una</p>
                    </div>
                `;
            }
        }
    } catch (error) {
        document.getElementById('reservas-loading').innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-exclamation-triangle text-2xl text-red-400"></i>
                <p class="mt-2 text-red-600">Error al cargar las reservas</p>
            </div>
        `;
    }
}

// Función para mostrar modal de nueva reserva
function showNuevaReserva() {
    // Implementar modal de nueva reserva
    showNotification('Información', 'Modal de nueva reserva en desarrollo', 'info');
}

// Función para seleccionar espacio
function selectEspacio(nombreEspacio) {
    showNotification('Espacio Seleccionado', `Has seleccionado: ${nombreEspacio}. Funcionalidad de reserva en desarrollo.`, 'info');
}

async function loadMisPagos() {
    const contentArea = document.getElementById('content-area');
    contentArea.innerHTML = `
        <div class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-900">Mis Pagos</h2>
                <div class="flex space-x-2">
                    <select class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option>Todos los meses</option>
                        <option>Septiembre 2025</option>
                        <option>Agosto 2025</option>
                        <option>Julio 2025</option>
                    </select>
                </div>
            </div>

            <!-- Loading -->
            <div id="pagos-loading" class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i>
                <p class="mt-2 text-gray-600">Cargando información de pagos...</p>
            </div>

            <!-- Content -->
            <div id="pagos-content" class="hidden">
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800">Historial de Pagos</h3>
                    </div>
                    <div id="pagos-list"></div>
                </div>
            </div>
        </div>
    `;

    try {
        const response = await fetchWithAuth('/api/residente/mis-pagos');
        const data = await response.json();

        if (data.success) {
            document.getElementById('pagos-loading').classList.add('hidden');
            document.getElementById('pagos-content').classList.remove('hidden');

            const pagosList = document.getElementById('pagos-list');
            if (data.recibos.length > 0) {
                pagosList.innerHTML = data.recibos.map(recibo => `
                    <div class="px-6 py-4 border-b border-gray-100 hover:bg-gray-50 last:border-b-0">
                        <div class="flex justify-between items-center">
                            <div class="flex-1">
                                <div class="flex items-center">
                                    <i class="fas fa-file-invoice-dollar text-green-600 mr-3"></i>
                                    <div>
                                        <h4 class="font-medium text-gray-900">${recibo.concepto}</h4>
                                        <p class="text-sm text-gray-600">
                                            Recibo: ${recibo.numeroRecibo} | Fecha: ${recibo.fechaPago}
                                        </p>
                                        <p class="text-xs text-gray-500 mt-1">
                                            Método: ${recibo.metodoPago}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-lg text-gray-900">$${recibo.valor.toLocaleString()}</p>
                                <div class="flex items-center mt-1">
                                    <button class="text-blue-600 hover:text-blue-800 text-sm mr-3">
                                        <i class="fas fa-download mr-1"></i>Descargar
                                    </button>
                                    <button class="text-green-600 hover:text-green-800 text-sm">
                                        <i class="fas fa-eye mr-1"></i>Ver
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                pagosList.innerHTML = `
                    <div class="px-6 py-8 text-center">
                        <i class="fas fa-receipt text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-600">No tienes recibos de pago registrados</p>
                        <p class="text-sm text-gray-500 mt-2">Los recibos aparecerán aquí cuando el administrador los suba</p>
                    </div>
                `;
            }
        }
    } catch (error) {
        document.getElementById('pagos-loading').innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-exclamation-triangle text-2xl text-red-400"></i>
                <p class="mt-2 text-red-600">Error al cargar los pagos</p>
            </div>
        `;
    }
}

async function loadEmprendimientos() {
    const contentArea = document.getElementById('content-area');
    contentArea.innerHTML = `
        <div class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-900">Emprendimientos Residenciales</h2>
                <button onclick="showRegistrarEmprendimiento()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Registrar Mi Emprendimiento
                </button>
            </div>

            <!-- Loading -->
            <div id="emprendimientos-loading" class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i>
                <p class="mt-2 text-gray-600">Cargando emprendimientos...</p>
            </div>

            <!-- Content -->
            <div id="emprendimientos-content" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Los emprendimientos se cargarán aquí -->
                </div>
            </div>
        </div>
    `;

    try {
        const response = await fetchWithAuth('/api/residente/emprendimientos');
        const data = await response.json();

        if (data.success) {
            document.getElementById('emprendimientos-loading').classList.add('hidden');
            document.getElementById('emprendimientos-content').classList.remove('hidden');

            const emprendimientosGrid = document.getElementById('emprendimientos-content').querySelector('.grid');
            if (data.emprendimientos.length > 0) {
                emprendimientosGrid.innerHTML = data.emprendimientos.map(emprendimiento => `
                    <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
                        <div class="p-6">
                            <div class="flex items-center mb-4">
                                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-store text-blue-600 text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <h3 class="font-semibold text-gray-900">${emprendimiento.nombre}</h3>
                                    <p class="text-sm text-gray-600">${emprendimiento.tipo}</p>
                                </div>
                            </div>

                            <p class="text-gray-700 mb-4">${emprendimiento.descripcion}</p>

                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600">
                                    <i class="fas fa-user mr-1"></i>${emprendimiento.propietario}
                                </span>
                                <button onclick="contactarEmprendimiento('${emprendimiento.telefono}', '${emprendimiento.nombre}')"
                                        class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                    <i class="fas fa-phone mr-2"></i>Contactar
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                emprendimientosGrid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-store text-4xl text-gray-300 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No hay emprendimientos registrados</h3>
                        <p class="text-gray-600">Sé el primero en registrar tu emprendimiento</p>
                    </div>
                `;
            }
        }
    } catch (error) {
        document.getElementById('emprendimientos-loading').innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-exclamation-triangle text-2xl text-red-400"></i>
                <p class="mt-2 text-red-600">Error al cargar los emprendimientos</p>
            </div>
        `;
    }
}

// Función para contactar emprendimiento con llamada directa
function contactarEmprendimiento(telefono, nombre) {
    if (confirm(`¿Deseas llamar a ${nombre} al número ${telefono}?`)) {
        window.location.href = `tel:${telefono}`;
    }
}

function showRegistrarEmprendimiento() {
    showNotification('Información', 'Funcionalidad de registro de emprendimientos en desarrollo', 'info');
}

// ================================
// MÓDULOS DE ADMINISTRADOR
// ================================

async function loadAdminDashboard() {
    const contentArea = document.getElementById('content-area');
    contentArea.innerHTML = `
        <div class="space-y-6">
            <!-- Header del Dashboard Admin -->
            <div class="bg-gradient-to-r from-green-600 to-green-700 rounded-lg p-6 text-white">
                <h2 class="text-2xl font-bold mb-2">Panel de Administración</h2>
                <p class="opacity-90">Sistema de Gestión - Conjunto Aralia de Castilla</p>
            </div>

            <!-- Stats Cards Principales -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-2 bg-blue-100 rounded-lg">
                            <i class="fas fa-users text-blue-600"></i>
                        </div>
                        <div class="ml-4">
                            <h4 class="text-sm font-medium text-gray-600">Total Residentes</h4>
                            <p class="text-2xl font-bold text-gray-900">87</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-2 bg-green-100 rounded-lg">
                            <i class="fas fa-calendar-check text-green-600"></i>
                        </div>
                        <div class="ml-4">
                            <h4 class="text-sm font-medium text-gray-600">Reservas Activas</h4>
                            <p class="text-2xl font-bold text-gray-900">12</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-2 bg-yellow-100 rounded-lg">
                            <i class="fas fa-car text-yellow-600"></i>
                        </div>
                        <div class="ml-4">
                            <h4 class="text-sm font-medium text-gray-600">Vehículos Visitantes</h4>
                            <p class="text-2xl font-bold text-gray-900">5</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-2 bg-red-100 rounded-lg">
                            <i class="fas fa-exclamation-triangle text-red-600"></i>
                        </div>
                        <div class="ml-4">
                            <h4 class="text-sm font-medium text-gray-600">PQRS Pendientes</h4>
                            <p class="text-2xl font-bold text-gray-900">3</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Acciones Rápidas -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">Acciones Rápidas</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button onclick="switchTab('noticias')" class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-center">
                        <i class="fas fa-newspaper text-green-600 text-2xl mb-2"></i>
                        <p class="text-sm font-medium">Crear Noticia</p>
                    </button>
                    <button onclick="switchTab('usuarios')" class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-center">
                        <i class="fas fa-user-plus text-blue-600 text-2xl mb-2"></i>
                        <p class="text-sm font-medium">Nuevo Usuario</p>
                    </button>
                    <button onclick="switchTab('sorteo-parqueaderos')" class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-center">
                        <i class="fas fa-random text-purple-600 text-2xl mb-2"></i>
                        <p class="text-sm font-medium">Sortear Parqueaderos</p>
                    </button>
                    <button onclick="switchTab('pqrs-admin')" class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-center">
                        <i class="fas fa-clipboard-list text-red-600 text-2xl mb-2"></i>
                        <p class="text-sm font-medium">Gestionar PQRS</p>
                    </button>
                </div>
            </div>

            <!-- Actividad Reciente -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">Actividad Reciente</h3>
                    <div class="space-y-3">
                        <div class="flex items-center text-sm">
                            <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                            <span class="text-gray-600">Nueva reserva de Salón Social - Carlos González</span>
                            <span class="text-gray-400 ml-auto">Hace 2 horas</span>
                        </div>
                        <div class="flex items-center text-sm">
                            <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                            <span class="text-gray-600">Nuevo usuario registrado - Ana Martínez</span>
                            <span class="text-gray-400 ml-auto">Hace 4 horas</span>
                        </div>
                        <div class="flex items-center text-sm">
                            <div class="w-2 h-2 bg-yellow-500 rounded-full mr-3"></div>
                            <span class="text-gray-600">PQRS enviada por residente Torre 3</span>
                            <span class="text-gray-400 ml-auto">Hace 6 horas</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">Próximos Eventos</h3>
                    <div class="space-y-3">
                        <div class="border-l-4 border-green-500 pl-4">
                            <h4 class="font-medium text-gray-900">Asamblea General</h4>
                            <p class="text-sm text-gray-600">30 de Septiembre - 3:00 PM</p>
                        </div>
                        <div class="border-l-4 border-blue-500 pl-4">
                            <h4 class="font-medium text-gray-900">Mantenimiento Ascensores</h4>
                            <p class="text-sm text-gray-600">20-21 de Septiembre</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

async function loadNoticias() {
    const contentArea = document.getElementById('content-area');
    contentArea.innerHTML = `
        <div class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-900">Gestión de Noticias</h2>
                <button onclick="showCrearNoticia()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Crear Noticia
                </button>
            </div>

            <!-- Formulario de nueva noticia (oculto inicialmente) -->
            <div id="form-nueva-noticia" class="bg-white rounded-lg shadow p-6 hidden">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">Nueva Noticia</h3>
                <form id="noticia-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Título</label>
                            <input type="text" id="noticia-titulo" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Categoría</label>
                            <select id="noticia-categoria" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="Administrativo">Administrativo</option>
                                <option value="Social">Social</option>
                                <option value="Mantenimiento">Mantenimiento</option>
                                <option value="Seguridad">Seguridad</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Contenido</label>
                        <textarea id="noticia-contenido" rows="4" required
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Fecha del Evento</label>
                            <input type="date" id="noticia-fecha-evento"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Hora del Evento</label>
                            <input type="time" id="noticia-hora-evento"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Lugar</label>
                            <input type="text" id="noticia-lugar"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Prioridad</label>
                        <select id="noticia-prioridad" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <option value="baja">Baja</option>
                            <option value="media">Media</option>
                            <option value="alta">Alta</option>
                        </select>
                    </div>

                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="cancelarNoticia()"
                                class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button type="submit"
                                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            Publicar Noticia
                        </button>
                    </div>
                </form>
            </div>

            <!-- Lista de noticias -->
            <div id="noticias-loading" class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i>
                <p class="mt-2 text-gray-600">Cargando noticias...</p>
            </div>

            <div id="noticias-content" class="hidden space-y-4">
                <!-- Las noticias se cargarán aquí -->
            </div>
        </div>
    `;

    // Event listener para el formulario
    document.getElementById('noticia-form').addEventListener('submit', crearNoticia);

    // Cargar noticias existentes
    await cargarNoticiasAdmin();
}

async function cargarNoticiasAdmin() {
    try {
        const response = await fetchWithAuth('/api/noticias');
        const noticias = await response.json();

        document.getElementById('noticias-loading').classList.add('hidden');
        document.getElementById('noticias-content').classList.remove('hidden');

        const noticiasContainer = document.getElementById('noticias-content');
        if (noticias.length > 0) {
            noticiasContainer.innerHTML = noticias.map(noticia => `
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <h3 class="text-lg font-semibold text-gray-900 mr-3">${noticia.titulo}</h3>
                                <span class="px-2 py-1 text-xs rounded-full ${getPriorityClass(noticia.prioridad)}">
                                    ${noticia.prioridad}
                                </span>
                                <span class="ml-2 px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded">
                                    ${noticia.categoria}
                                </span>
                            </div>
                            <p class="text-gray-600 mb-3">${noticia.contenido}</p>
                            <div class="flex items-center text-sm text-gray-500 space-x-4">
                                <span><i class="fas fa-calendar mr-1"></i>Publicado: ${noticia.fecha}</span>
                                ${noticia.fechaEvento ? `<span><i class="fas fa-clock mr-1"></i>Evento: ${noticia.fechaEvento} ${noticia.horaEvento || ''}</span>` : ''}
                                ${noticia.lugar ? `<span><i class="fas fa-map-marker-alt mr-1"></i>${noticia.lugar}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 ml-4">
                            <button onclick="editarNoticia(${noticia.id})"
                                    class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="eliminarNoticia(${noticia.id})"
                                    class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            noticiasContainer.innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-newspaper text-4xl text-gray-300 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No hay noticias publicadas</h3>
                    <p class="text-gray-600">Crea la primera noticia para informar a los residentes</p>
                </div>
            `;
        }
    } catch (error) {
        document.getElementById('noticias-loading').innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-exclamation-triangle text-2xl text-red-400"></i>
                <p class="mt-2 text-red-600">Error al cargar las noticias</p>
            </div>
        `;
    }
}

function getPriorityClass(prioridad) {
    switch(prioridad) {
        case 'alta': return 'bg-red-100 text-red-800';
        case 'media': return 'bg-yellow-100 text-yellow-800';
        case 'baja': return 'bg-green-100 text-green-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

function showCrearNoticia() {
    document.getElementById('form-nueva-noticia').classList.remove('hidden');
}

function cancelarNoticia() {
    document.getElementById('form-nueva-noticia').classList.add('hidden');
    document.getElementById('noticia-form').reset();
}

async function crearNoticia(e) {
    e.preventDefault();

    const formData = {
        titulo: document.getElementById('noticia-titulo').value,
        contenido: document.getElementById('noticia-contenido').value,
        categoria: document.getElementById('noticia-categoria').value,
        fechaEvento: document.getElementById('noticia-fecha-evento').value,
        horaEvento: document.getElementById('noticia-hora-evento').value,
        lugar: document.getElementById('noticia-lugar').value,
        prioridad: document.getElementById('noticia-prioridad').value
    };

    try {
        const response = await fetchWithAuth('/api/admin/noticias', {
            method: 'POST',
            body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (data.success) {
            showNotification('Éxito', 'Noticia creada exitosamente', 'success');
            cancelarNoticia();
            await cargarNoticiasAdmin();
        } else {
            showNotification('Error', data.mensaje || 'Error al crear la noticia', 'error');
        }
    } catch (error) {
        showNotification('Error', 'Error de conexión', 'error');
    }
}

async function eliminarNoticia(id) {
    if (confirm('¿Estás seguro de que quieres eliminar esta noticia?')) {
        try {
            const response = await fetchWithAuth(`/api/admin/noticias/${id}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (data.success) {
                showNotification('Éxito', 'Noticia eliminada exitosamente', 'success');
                await cargarNoticiasAdmin();
            } else {
                showNotification('Error', 'Error al eliminar la noticia', 'error');
            }
        } catch (error) {
            showNotification('Error', 'Error de conexión', 'error');
        }
    }
}

async function loadUsuarios() {
    const contentArea = document.getElementById('content-area');
    contentArea.innerHTML = `
        <div class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-900">Gestión de Usuarios</h2>
                <button onclick="showCrearUsuario()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-user-plus mr-2"></i>Crear Usuario
                </button>
            </div>

            <!-- Formulario de nuevo usuario -->
            <div id="form-nuevo-usuario" class="bg-white rounded-lg shadow p-6 hidden">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">Nuevo Usuario</h3>
                <form id="usuario-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo</label>
                            <input type="text" id="usuario-nombre" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="usuario-email" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Torre</label>
                            <select id="usuario-torre" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="">Seleccionar Torre</option>
                                ${Array.from({length: 10}, (_, i) => `<option value="${i + 1}">Torre ${i + 1}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Apartamento</label>
                            <input type="text" id="usuario-apartamento" required placeholder="Ej: 301A"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Rol</label>
                            <select id="usuario-rol" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="residente">Residente</option>
                                <option value="admin">Administrador</option>
                                <option value="vigilante">Vigilante</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Contraseña Temporal</label>
                        <input type="password" id="usuario-password" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>

                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="cancelarUsuario()"
                                class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button type="submit"
                                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            Crear Usuario
                        </button>
                    </div>
                </form>
            </div>

            <!-- Lista de usuarios -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800">Usuarios del Sistema</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Apartamento</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rol</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="usuarios-table" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                    <i class="fas fa-spinner fa-spin text-xl mb-2"></i>
                                    <p>Cargando usuarios...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

    // Event listener para el formulario
    document.getElementById('usuario-form').addEventListener('submit', crearUsuario);

    // Cargar usuarios
    await cargarUsuarios();
}

async function cargarUsuarios() {
    try {
        const response = await fetchWithAuth('/api/usuarios');
        const usuarios = await response.json();

        const tbody = document.getElementById('usuarios-table');
        if (usuarios.length > 0) {
            tbody.innerHTML = usuarios.map(usuario => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center mr-3">
                                <i class="fas fa-user text-gray-500"></i>
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-900">${usuario.nombre}</div>
                                <div class="text-sm text-gray-500">${usuario.id}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${usuario.apartamento}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${getRoleClass(usuario.rol || 'residente')}">
                            ${getRoleName(usuario.rol || 'residente')}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${usuario.activo ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${usuario.activo ? 'Activo' : 'Inactivo'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        <button onclick="editarUsuario(${usuario.id})" class="text-blue-600 hover:text-blue-900">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="toggleUsuario(${usuario.id}, ${usuario.activo})" class="text-yellow-600 hover:text-yellow-900">
                            <i class="fas fa-${usuario.activo ? 'pause' : 'play'}"></i>
                        </button>
                        <button onclick="eliminarUsuario(${usuario.id})" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                        <i class="fas fa-users text-4xl mb-4"></i>
                        <p>No hay usuarios registrados</p>
                    </td>
                </tr>
            `;
        }
    } catch (error) {
        document.getElementById('usuarios-table').innerHTML = `
            <tr>
                <td colspan="5" class="px-6 py-8 text-center text-red-500">
                    <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                    <p>Error al cargar los usuarios</p>
                </td>
            </tr>
        `;
    }
}

function getRoleClass(rol) {
    switch(rol) {
        case 'admin': return 'bg-green-100 text-green-800';
        case 'vigilante': return 'bg-orange-100 text-orange-800';
        case 'residente': return 'bg-blue-100 text-blue-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

function getRoleName(rol) {
    switch(rol) {
        case 'admin': return 'Administrador';
        case 'vigilante': return 'Vigilante';
        case 'residente': return 'Residente';
        default: return 'Sin rol';
    }
}

function showCrearUsuario() {
    document.getElementById('form-nuevo-usuario').classList.remove('hidden');
}

function cancelarUsuario() {
    document.getElementById('form-nuevo-usuario').classList.add('hidden');
    document.getElementById('usuario-form').reset();
}

async function crearUsuario(e) {
    e.preventDefault();

    const formData = {
        nombre: document.getElementById('usuario-nombre').value,
        email: document.getElementById('usuario-email').value,
        password: document.getElementById('usuario-password').value,
        torre: document.getElementById('usuario-torre').value,
        apartamento: document.getElementById('usuario-apartamento').value,
        rol: document.getElementById('usuario-rol').value
    };

    try {
        const response = await fetchWithAuth('/api/admin/usuarios', {
            method: 'POST',
            body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (data.success) {
            showNotification('Éxito', 'Usuario creado exitosamente', 'success');
            cancelarUsuario();
            await cargarUsuarios();
        } else {
            showNotification('Error', data.mensaje || 'Error al crear el usuario', 'error');
        }
    } catch (error) {
        showNotification('Error', 'Error de conexión', 'error');
    }
}

// ================================
// MÓDULOS DE VIGILANTE
// ================================

async function loadPanelSeguridad() {
    const contentArea = document.getElementById('content-area');
    contentArea.innerHTML = `
        <div class="space-y-6">
            <!-- Header del Panel Vigilante -->
            <div class="bg-gradient-to-r from-orange-600 to-orange-700 rounded-lg p-6 text-white">
                <h2 class="text-2xl font-bold mb-2">Panel de Seguridad</h2>
                <p class="opacity-90">Centro de Control - Conjunto Aralia de Castilla</p>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-2 bg-yellow-100 rounded-lg">
                            <i class="fas fa-car text-yellow-600"></i>
                        </div>
                        <div class="ml-4">
                            <h4 class="text-sm font-medium text-gray-600">Vehículos Activos</h4>
                            <p id="vehiculos-activos-count" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-2 bg-blue-100 rounded-lg">
                            <i class="fas fa-key text-blue-600"></i>
                        </div>
                        <div class="ml-4">
                            <h4 class="text-sm font-medium text-gray-600">Permisos Pendientes</h4>
                            <p class="text-2xl font-bold text-gray-900">2</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-2 bg-green-100 rounded-lg">
                            <i class="fas fa-clock text-green-600"></i>
                        </div>
                        <div class="ml-4">
                            <h4 class="text-sm font-medium text-gray-600">Horas de Turno</h4>
                            <p class="text-2xl font-bold text-gray-900">8</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-2 bg-red-100 rounded-lg">
                            <i class="fas fa-exclamation-triangle text-red-600"></i>
                        </div>
                        <div class="ml-4">
                            <h4 class="text-sm font-medium text-gray-600">Alertas</h4>
                            <p class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Accesos Rápidos -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">Accesos Rápidos</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button onclick="switchTab('control-vehiculos-vigilante')" class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-center">
                        <i class="fas fa-car text-orange-600 text-2xl mb-2"></i>
                        <p class="text-sm font-medium">Control Vehículos</p>
                    </button>
                    <button onclick="switchTab('permisos-vigilante')" class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-center">
                        <i class="fas fa-key text-blue-600 text-2xl mb-2"></i>
                        <p class="text-sm font-medium">Permisos</p>
                    </button>
                    <button onclick="switchTab('camaras-vigilante')" class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-center">
                        <i class="fas fa-video text-purple-600 text-2xl mb-2"></i>
                        <p class="text-sm font-medium">Cámaras</p>
                    </button>
                    <button onclick="switchTab('registros')" class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-center">
                        <i class="fas fa-clipboard-list text-green-600 text-2xl mb-2"></i>
                        <p class="text-sm font-medium">Registros</p>
                    </button>
                </div>
            </div>

            <!-- Actividad en Tiempo Real -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">Vehículos en Conjunto</h3>
                    <div id="vehiculos-tiempo-real" class="space-y-3">
                        <div class="text-center py-4">
                            <i class="fas fa-spinner fa-spin text-gray-400"></i>
                            <p class="text-sm text-gray-500 mt-2">Cargando vehículos activos...</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">Últimas Actividades</h3>
                    <div class="space-y-3">
                        <div class="flex items-center text-sm">
                            <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                            <span class="text-gray-600">Vehículo ABC123 ingresó - Torre 2</span>
                            <span class="text-gray-400 ml-auto">10:30 AM</span>
                        </div>
                        <div class="flex items-center text-sm">
                            <div class="w-2 h-2 bg-red-500 rounded-full mr-3"></div>
                            <span class="text-gray-600">Vehículo XYZ789 salió - Pago: $3,000</span>
                            <span class="text-gray-400 ml-auto">10:15 AM</span>
                        </div>
                        <div class="flex items-center text-sm">
                            <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                            <span class="text-gray-600">Permiso aprobado - Visitante Juan</span>
                            <span class="text-gray-400 ml-auto">09:45 AM</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Cargar vehículos activos
    await cargarVehiculosActivos();
}

async function loadControlVehiculosVigilante() {
    const contentArea = document.getElementById('content-area');
    contentArea.innerHTML = `
        <div class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-900">Control de Vehículos</h2>
                <button onclick="showRegistrarVehiculo()" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Registrar Ingreso
                </button>
            </div>

            <!-- Formulario de registro -->
            <div id="form-registro-vehiculo" class="bg-white rounded-lg shadow p-6 hidden">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">Registrar Ingreso de Vehículo</h3>
                <form id="vehiculo-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Placa del Vehículo</label>
                            <input type="text" id="vehiculo-placa" required placeholder="ABC123"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent uppercase">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Vehículo</label>
                            <select id="vehiculo-tipo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                <option value="Carro">Carro</option>
                                <option value="Moto">Moto</option>
                                <option value="Camioneta">Camioneta</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Apartamento que Visita</label>
                            <input type="text" id="vehiculo-apartamento" required placeholder="Torre 1 - Apto 301"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del Visitante</label>
                            <input type="text" id="vehiculo-visitante" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="cancelarRegistroVehiculo()"
                                class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button type="submit"
                                class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                            Registrar Ingreso
                        </button>
                    </div>
                </form>
            </div>

            <!-- Lista de vehículos activos -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800">Vehículos en el Conjunto</h3>
                </div>
                <div id="vehiculos-activos-content">
                    <div class="px-6 py-8 text-center">
                        <i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i>
                        <p class="mt-2 text-gray-600">Cargando vehículos activos...</p>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Event listener para el formulario
    document.getElementById('vehiculo-form').addEventListener('submit', registrarVehiculo);

    // Cargar vehículos activos
    await cargarVehiculosActivosVigilante();
}

async function cargarVehiculosActivos() {
    try {
        const response = await fetchWithAuth('/api/vigilante/vehiculos-activos');
        const data = await response.json();

        const vehiculosContainer = document.getElementById('vehiculos-tiempo-real');
        document.getElementById('vehiculos-activos-count').textContent = data.vehiculos.length;

        if (data.vehiculos.length > 0) {
            vehiculosContainer.innerHTML = data.vehiculos.map(vehiculo => {
                const tiempoIngreso = new Date(vehiculo.fechaIngreso);
                const ahora = new Date();
                const horasTranscurridas = Math.floor((ahora - tiempoIngreso) / (1000 * 60 * 60));
                const minutosTranscurridos = Math.floor(((ahora - tiempoIngreso) % (1000 * 60 * 60)) / (1000 * 60));

                return `
                    <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0">
                        <div class="flex items-center">
                            <i class="fas fa-car text-orange-600 mr-3"></i>
                            <div>
                                <p class="font-medium text-gray-900">${vehiculo.placa}</p>
                                <p class="text-sm text-gray-600">${vehiculo.visitaA}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-medium text-gray-900">${horasTranscurridas}h ${minutosTranscurridos}m</p>
                            <p class="text-xs text-gray-500">${vehiculo.tipoVehiculo}</p>
                        </div>
                    </div>
                `;
            }).join('');
        } else {
            vehiculosContainer.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-car text-gray-300 text-2xl mb-2"></i>
                    <p class="text-gray-500">No hay vehículos en el conjunto</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error al cargar vehículos activos:', error);
    }
}

async function cargarVehiculosActivosVigilante() {
    try {
        const response = await fetchWithAuth('/api/vigilante/vehiculos-activos');
        const data = await response.json();

        const contentDiv = document.getElementById('vehiculos-activos-content');
        if (data.vehiculos.length > 0) {
            contentDiv.innerHTML = data.vehiculos.map(vehiculo => {
                const tiempoIngreso = new Date(vehiculo.fechaIngreso);
                const ahora = new Date();
                const horasTranscurridas = Math.floor((ahora - tiempoIngreso) / (1000 * 60 * 60));
                const minutosTranscurridos = Math.floor(((ahora - tiempoIngreso) % (1000 * 60 * 60)) / (1000 * 60));

                // Calcular tarifa estimada
                let tarifaEstimada = 0;
                if (horasTranscurridas > 2) {
                    if (horasTranscurridas > 10) {
                        tarifaEstimada = Math.ceil(horasTranscurridas / 24) * 12000;
                    } else {
                        tarifaEstimada = (horasTranscurridas - 2) * 1000;
                    }
                }

                return `
                    <div class="px-6 py-4 border-b border-gray-100 last:border-b-0">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <div class="p-2 bg-orange-100 rounded-lg mr-4">
                                    <i class="fas fa-car text-orange-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-900">${vehiculo.placa}</h4>
                                    <p class="text-sm text-gray-600">${vehiculo.tipoVehiculo} - ${vehiculo.visitaA}</p>
                                    <p class="text-xs text-gray-500">
                                        Visitante: ${vehiculo.nombreVisitante || 'No especificado'}
                                    </p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-semibold text-gray-900">${horasTranscurridas}h ${minutosTranscurridas}m</div>
                                <div class="text-sm text-gray-600">
                                    Ingreso: ${tiempoIngreso.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' })}
                                </div>
                                <div class="text-sm font-medium text-green-600">
                                    Tarifa: $${tarifaEstimada.toLocaleString()}
                                </div>
                                <button onclick="procesarSalidaVehiculo('${vehiculo.placa}')"
                                        class="mt-2 px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                                    <i class="fas fa-stop mr-1"></i>STOP
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        } else {
            contentDiv.innerHTML = `
                <div class="px-6 py-8 text-center">
                    <i class="fas fa-car text-4xl text-gray-300 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No hay vehículos en el conjunto</h3>
                    <p class="text-gray-600">Los vehículos visitantes aparecerán aquí</p>
                </div>
            `;
        }
    } catch (error) {
        document.getElementById('vehiculos-activos-content').innerHTML = `
            <div class="px-6 py-8 text-center text-red-500">
                <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                <p>Error al cargar los vehículos</p>
            </div>
        `;
    }
}

function showRegistrarVehiculo() {
    document.getElementById('form-registro-vehiculo').classList.remove('hidden');
}

function cancelarRegistroVehiculo() {
    document.getElementById('form-registro-vehiculo').classList.add('hidden');
    document.getElementById('vehiculo-form').reset();
}

async function registrarVehiculo(e) {
    e.preventDefault();

    const formData = {
        placa: document.getElementById('vehiculo-placa').value,
        tipoVehiculo: document.getElementById('vehiculo-tipo').value,
        visitaA: document.getElementById('vehiculo-apartamento').value,
        nombreVisitante: document.getElementById('vehiculo-visitante').value
    };

    try {
        const response = await fetchWithAuth('/api/vigilante/vehiculos/ingreso', {
            method: 'POST',
            body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (data.success) {
            showNotification('Éxito', `Vehículo ${data.vehiculo.placa} registrado exitosamente`, 'success');
            cancelarRegistroVehiculo();
            await cargarVehiculosActivosVigilante();
            await cargarVehiculosActivos(); // Actualizar el panel principal también
        } else {
            showNotification('Error', data.mensaje || 'Error al registrar el vehículo', 'error');
        }
    } catch (error) {
        showNotification('Error', 'Error de conexión', 'error');
    }
}

async function procesarSalidaVehiculo(placa) {
    if (confirm(`¿Procesar salida del vehículo ${placa}?`)) {
        try {
            const response = await fetchWithAuth('/api/vigilante/vehiculos/salida', {
                method: 'POST',
                body: JSON.stringify({ placa })
            });

            const data = await response.json();

            if (data.success) {
                // Mostrar información del recibo
                const recibo = data.recibo;
                showNotification('Salida Procesada',
                    `Vehículo: ${placa}\nTiempo total: ${recibo.totalHoras} horas\nTotal a pagar: $${recibo.totalCobrado.toLocaleString()}\nRecibo: ${recibo.id}`,
                    'success');

                await cargarVehiculosActivosVigilante();
                await cargarVehiculosActivos();
            } else {
                showNotification('Error', data.mensaje || 'Error al procesar la salida', 'error');
            }
        } catch (error) {
            showNotification('Error', 'Error de conexión', 'error');
        }
    }
}

// ================================
// FUNCIONES GENERALES
// ================================

// Función auxiliar para hacer peticiones con autenticación
async function fetchWithAuth(url, options = {}) {
    const token = localStorage.getItem('token');
    const defaultHeaders = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
    };

    return fetch(url, {
        ...options,
        headers: {
            ...defaultHeaders,
            ...options.headers
        }
    });
}

// Función para mostrar notificaciones
function showNotification(title, message, type = 'info') {
    const modal = document.getElementById('notification-modal');
    const content = document.getElementById('notification-content');

    const typeClasses = {
        success: 'text-green-600',
        error: 'text-red-600',
        warning: 'text-yellow-600',
        info: 'text-blue-600'
    };

    const typeIcons = {
        success: 'fas fa-check-circle',
        error: 'fas fa-exclamation-triangle',
        warning: 'fas fa-exclamation-circle',
        info: 'fas fa-info-circle'
    };

    content.innerHTML = `
        <div class="flex items-start">
            <i class="${typeIcons[type]} ${typeClasses[type]} text-xl mr-3 mt-1"></i>
            <div>
                <h4 class="font-medium text-gray-900 mb-1">${title}</h4>
                <p class="text-gray-600 text-sm whitespace-pre-line">${message}</p>
            </div>
        </div>
    `;

    modal.classList.remove('hidden');
}

function closeNotificationModal() {
    document.getElementById('notification-modal').classList.add('hidden');
}

// Función de logout
function logout() {
    if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        currentUser = null;

        document.getElementById('app').classList.add('hidden');
        document.getElementById('login-screen').classList.remove('hidden');
    }
}

// Verificar autenticación al cargar la página
document.addEventListener('DOMContentLoaded', () => {
    const token = localStorage.getItem('token');
    const user = localStorage.getItem('user');

    if (token && user) {
        try {
            currentUser = JSON.parse(user);
            showApp();
        } catch (error) {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
        }
    }
});

// Funciones placeholder para módulos no implementados completamente
function loadArriendos() {
    document.getElementById('content-area').innerHTML = `
        <div class="text-center py-12">
            <i class="fas fa-home text-4xl text-blue-400 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Módulo de Arriendos</h3>
            <p class="text-gray-600">Funcionalidad en desarrollo</p>
        </div>
    `;
}

function loadMiParqueadero() {
    document.getElementById('content-area').innerHTML = `
        <div class="text-center py-12">
            <i class="fas fa-parking text-4xl text-purple-400 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Mi Parqueadero Asignado</h3>
            <p class="text-gray-600">Funcionalidad en desarrollo</p>
        </div>
    `;
}

function loadMisVehiculos() {
    document.getElementById('content-area').innerHTML = `
        <div class="text-center py-12">
            <i class="fas fa-car text-4xl text-green-400 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Mis Vehículos Visitantes</h3>
            <p class="text-gray-600">Funcionalidad en desarrollo</p>
        </div>
    `;
}

function loadPaquetes() {
    document.getElementById('content-area').innerHTML = `
        <div class="text-center py-12">
            <i class="fas fa-box text-4xl text-yellow-400 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Notificación de Paquetes</h3>
            <p class="text-gray-600">Funcionalidad en desarrollo</p>
        </div>
    `;
}

function loadChat() {
    document.getElementById('content-area').innerHTML = `
        <div class="text-center py-12">
            <i class="fas fa-comments text-4xl text-indigo-400 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Sistema de Chat</h3>
            <p class="text-gray-600">Funcionalidad en desarrollo</p>
        </div>
    `;
}

function loadCamaras() {
    document.getElementById('content-area').innerHTML = `
        <div class="text-center py-12">
            <i class="fas fa-video text-4xl text-red-400 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Cámaras de Seguridad</h3>
            <p class="text-gray-600">Funcionalidad en desarrollo</p>
        </div>
    `;
}

function loadPQRS() {
    document.getElementById('content-area').innerHTML = `
        <div class="text-center py-12">
            <i class="fas fa-exclamation-triangle text-4xl text-orange-400 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Sistema PQRS</h3>
            <p class="text-gray-600">Funcionalidad en desarrollo</p>
        </div>
    `;
}
</script>

</body>
</html>